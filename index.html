<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nano Banana Studio | Mobile Final v1.9</title>
    
    <meta name="description" content="AI image generation studio powered by Google Gemini 3 Pro.">
    <meta property="og:title" content="Nano Banana Studio">
    <meta property="og:image" content="https://emojicdn.elk.sh/ğŸŒ">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            overscroll-behavior-y: none;
        }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .loader {
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top: 3px solid #facc15;
            width: 32px; height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tag Button Styles */
        .tag-btn {
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
            background-color: #ffffff;
            color: #334155;
            font-weight: 500;
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }
        .tag-btn:active { transform: scale(0.96); background-color: #fefce8; }
        .tag-btn.active {
            border-color: #15803d;
            background-color: #dcfce7;
            color: #166534;
            font-weight: 700;
            position: relative;
        }
        .tag-btn.active::after {
            content: 'âœ“';
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 10px;
            color: #15803d;
        }
        
        .tab-content {
            display: none;
            opacity: 0;
            width: 100%;
            flex-grow: 1;
            transition: opacity 0.2s ease-in-out;
        }
        .tab-content.active { display: flex; opacity: 1; }

        #styleTooltip { transition: opacity 0.2s; pointer-events: none; }
        #lightbox { transition: opacity 0.3s ease; }
        #lightbox.hidden { opacity: 0; pointer-events: none; }
        #lightbox:not(.hidden) { opacity: 1; pointer-events: auto; }
        .custom-checkbox:checked { background-color: #15803d; border-color: #15803d; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden selection:bg-yellow-300 selection:text-green-900">

    <!-- Header -->
    <header class="h-14 md:h-16 bg-green-800 border-b-4 border-yellow-400 flex items-center justify-between px-3 md:px-6 shrink-0 z-50 shadow-md gap-2 md:gap-4 relative">
        <!-- Left: Logo -->
        <div class="flex items-center gap-2 shrink-0">
            <div class="w-8 h-8 md:w-10 md:h-10 bg-yellow-400 rounded-lg md:rounded-xl flex items-center justify-center text-green-900 font-black text-xl md:text-2xl shadow-sm">ğŸŒ</div>
            <h1 class="text-lg md:text-xl font-bold text-white tracking-wide hidden sm:block">Nano Banana</h1>
        </div>
        
        <!-- Center: Nav -->
        <nav class="flex-1 flex justify-center min-w-0">
            <div class="flex bg-green-900/50 p-1 rounded-full border border-green-600/30 backdrop-blur-sm whitespace-nowrap overflow-x-auto no-scrollbar">
                <button onclick="switchTab('phase1')" id="tab-phase1" class="px-3 md:px-6 py-1 md:py-1.5 rounded-full text-xs md:text-sm font-bold transition-all duration-300 flex items-center gap-1.5">
                    <i data-lucide="beaker" class="w-3 h-3 md:w-4 md:h-4"></i> <span>éˆæ„Ÿ</span>
                </button>
                <button onclick="switchTab('phase2')" id="tab-phase2" class="px-3 md:px-6 py-1 md:py-1.5 rounded-full text-xs md:text-sm font-bold transition-all duration-300 flex items-center gap-1.5">
                    <i data-lucide="image" class="w-3 h-3 md:w-4 md:h-4"></i> <span>å½±åƒ</span>
                </button>
            </div>
        </nav>

        <!-- Right: Controls -->
        <div class="flex items-center gap-2 shrink-0">
            <button onclick="showLastToast()" class="p-1.5 md:p-2 rounded-full bg-green-700/50 text-green-100" title="é€šçŸ¥"><i data-lucide="bell" class="w-4 h-4 md:w-5 md:h-5"></i></button>
            
            <button onclick="toggleMobileKeyInput()" class="md:hidden p-1.5 rounded-full bg-green-700/50 text-green-100"><i data-lucide="key" class="w-4 h-4"></i></button>

            <div class="relative group hidden md:block">
                <input type="password" id="apiKeyInput" placeholder="API Key" autocomplete="new-password"
                    class="bg-green-700/50 border border-green-600 text-white placeholder-green-200/70 text-sm rounded-lg px-3 py-1.5 w-32 focus:outline-none focus:border-yellow-400">
            </div>
            
            <button onclick="saveApiKey()" class="hidden md:block text-xs bg-green-900 hover:bg-green-700 text-yellow-300 font-bold px-3 py-2 rounded-lg border border-green-700">å„²å­˜</button>
        </div>
    </header>

    <!-- Mobile Key Input Drawer -->
    <div id="mobileKeyDrawer" class="hidden bg-green-900 border-b border-green-700 p-3 fixed top-14 left-0 w-full z-40 flex gap-2 shadow-xl">
        <input type="password" id="mobileApiKeyInput" placeholder="è²¼ä¸Š Key ä¸¦æŒ‰ Enter..." 
            class="flex-1 bg-green-800 text-white text-base rounded px-3 py-2 border border-green-600 focus:border-yellow-400 outline-none"
            onkeydown="checkMobileKeyEnter(event)">
        <button onclick="saveMobileKey()" class="bg-yellow-400 text-green-900 font-bold px-4 py-2 rounded text-sm shrink-0 whitespace-nowrap">å„²å­˜</button>
    </div>

    <!-- Phase 1: éˆæ„Ÿå¯¦é©—å®¤ -->
    <main id="view-phase1" class="tab-content active w-full overflow-hidden bg-slate-50 flex-col md:flex-row relative">
        <div class="w-full md:w-[350px] lg:w-[420px] shrink-0 bg-white md:bg-slate-50 border-b md:border-b-0 md:border-l border-slate-200 flex flex-col order-1 md:order-2 z-20 h-auto md:h-full shadow-sm md:shadow-none">
             <div class="p-3 md:p-4 border-b border-slate-100 md:border-slate-200 flex justify-between items-center">
                <label class="text-green-700 text-xs font-black uppercase tracking-widest flex items-center gap-2">
                    <span class="bg-yellow-300 text-green-900 px-1.5 py-0.5 rounded text-[10px]">STEP 1</span>
                    å’’èªè¼¸å…¥
                </label>
             </div>

             <div class="p-3 md:p-4 flex flex-col gap-3">
                <textarea id="builderPrompt" rows="3"
                    class="w-full bg-slate-50 md:bg-white border border-slate-300 md:border-slate-200 rounded-xl p-3 text-base text-slate-800 font-medium focus:outline-none focus:border-yellow-400 focus:ring-2 focus:ring-yellow-100 transition-all resize-none placeholder-slate-400"
                    placeholder="è¼¸å…¥æè¿°... (ä¾‹å¦‚ï¼šä¸€éš»æˆ´è‘—å¢¨é¡çš„é³³æ¢¨)"></textarea>

                <div class="flex items-center justify-between">
                    <label class="flex items-center gap-2 cursor-pointer select-none">
                        <input type="checkbox" id="anatomyFixCheck" class="custom-checkbox w-4 h-4 border-2 border-indigo-300 rounded text-indigo-600 focus:ring-indigo-500">
                        <span class="text-xs font-bold text-indigo-700">ä¿®å¾©äººé«”</span>
                    </label>
                    <span id="tagCountBadge" class="bg-green-100 text-green-800 text-[10px] font-bold px-2 py-1 rounded-full">å·²é¸ 0</span>
                </div>
                
                <button onclick="transferToPhase2()" class="w-full bg-yellow-400 hover:bg-yellow-300 text-green-900 font-black px-4 py-3 rounded-xl flex items-center justify-center gap-2 shadow-sm active:scale-[0.98] transition-all">
                    å»ç”Ÿæˆåœ–ç‰‡ <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
             </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 md:bg-white order-2 md:order-1 relative pb-20" id="styleContainer">
            <div class="mb-4 md:mb-6">
                <h2 class="text-lg md:text-2xl font-black text-slate-800 flex items-center gap-2"><span class="text-2xl md:text-3xl">ğŸ¨</span> é¢¨æ ¼å¯¦é©—å®¤</h2>
                <p class="text-slate-500 text-xs md:text-sm mt-1">é»æ“Šé¸æ“‡é¢¨æ ¼ (æ¯é¡å–®é¸)</p>
            </div>
            <div id="taxonomyContainer" class="space-y-6"></div>
        </div>
    </main>

    <!-- Phase 2: å½±åƒå·¥ä½œå®¤ -->
    <main id="view-phase2" class="tab-content w-full flex-col md:flex-row overflow-hidden bg-slate-100">
        <aside class="w-full md:w-80 lg:w-96 bg-white border-b md:border-b-0 md:border-r border-slate-200 flex flex-col p-4 md:p-6 gap-4 shrink-0 shadow-sm z-10 h-auto md:h-full overflow-y-auto max-h-[40vh] md:max-h-full">
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center justify-between">
                    <span class="flex items-center gap-2 text-green-700"><i data-lucide="sparkles" class="w-3 h-3 text-yellow-500"></i> æœ€çµ‚æç¤ºè©</span>
                    <button onclick="switchTab('phase1')" class="text-[10px] text-green-600 bg-green-50 px-2 py-1 rounded">ä¿®æ”¹</button>
                </label>
                <textarea id="promptInput" rows="3" 
                    class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-base md:text-sm focus:outline-none focus:border-yellow-400 resize-none text-slate-700"></textarea>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-1 gap-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase flex justify-between">
                        <span>åƒè€ƒåœ–</span>
                        <button onclick="clearRefImage()" id="clearRefBtn" class="hidden text-xs text-red-500">æ¸…é™¤</button>
                    </label>
                    <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-lg p-2 md:p-4 text-center relative group bg-slate-50 h-24 md:h-auto flex flex-col justify-center items-center">
                        <input type="file" id="imageInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 z-10">
                        <div id="uploadPlaceholder" class="flex flex-col items-center gap-1 text-slate-400">
                            <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                            <span class="text-[10px]">ä¸Šå‚³åœ–ç‰‡</span>
                        </div>
                        <img id="refImagePreview" class="hidden w-full h-full object-contain rounded">
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">æ¯”ä¾‹</label>
                    <div class="relative">
                        <select id="aspectRatio" class="w-full appearance-none bg-slate-50 border border-slate-200 text-slate-700 rounded-lg px-3 py-2 text-base md:text-sm focus:outline-none focus:border-green-500">
                            <option value="1:1">1:1 (æ­£æ–¹)</option>
                            <option value="3:4">3:4 (ç›´å¼)</option>
                            <option value="9:16">9:16 (æ‰‹æ©Ÿ)</option>
                            <option value="4:3">4:3 (æ©«å¼)</option>
                            <option value="16:9">16:9 (å¯¬è¢å¹•)</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-3 h-3 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
            </div>

            <div class="mt-auto pt-2 md:pt-6">
                <button id="generateBtn" onclick="generateImage()" 
                    class="w-full bg-yellow-400 hover:bg-yellow-300 text-green-900 font-black py-3 md:py-4 rounded-xl shadow-sm active:scale-[0.98] flex items-center justify-center gap-2 transition-all">
                    <i data-lucide="zap" class="w-4 h-4 md:w-5 md:h-5"></i> é–‹å§‹ç”Ÿæˆ
                </button>
            </div>
        </aside>

        <section class="flex-1 flex flex-col bg-slate-100 relative min-w-0 h-full overflow-hidden">
            <div class="flex-1 flex items-center justify-center p-4 md:p-8 overflow-hidden relative" id="canvasContainer">
                <div class="absolute inset-0 opacity-[0.03] pointer-events-none" style="background-image: radial-gradient(#15803d 1px, transparent 1px); background-size: 24px 24px;"></div>
                
                <div id="welcomeState" class="text-center text-slate-400 max-w-xs relative z-10">
                    <div class="mb-4 inline-block p-4 md:p-6 rounded-full bg-white border-4 border-slate-100 shadow-sm"><i data-lucide="palette" class="w-10 h-10 md:w-12 md:h-12 text-yellow-400"></i></div>
                    <h2 class="text-lg md:text-xl font-bold text-slate-700 mb-1">æº–å‚™å‰µä½œ</h2>
                    <p class="text-xs md:text-sm text-slate-500">è¨­å®šåƒæ•¸å¾Œé»æ“Šç”Ÿæˆ</p>
                </div>
                
                <div id="loadingState" class="hidden absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center backdrop-blur-sm">
                    <div class="loader mb-4"></div>
                    <p class="text-green-700 font-bold text-sm md:text-lg animate-pulse">æ­£åœ¨èª¿è£½å¥ˆç±³é¦™è•‰...</p>
                    <p class="text-slate-400 font-mono text-xs mt-2 bg-slate-100 px-3 py-1 rounded-full" id="loadingTime">0.0s</p>
                </div>

                <div id="resultContainer" class="hidden relative group w-full h-full flex items-center justify-center">
                    <div class="relative w-full h-full flex items-center justify-center" onclick="openLightbox()">
                        <img id="generatedImage" class="max-w-full max-h-full rounded-lg shadow-xl object-contain border-2 border-white bg-[url('https://www.transparenttextures.com/patterns/checkerboard-white.png')]" src="" alt="Generated Content">
                    </div>
                    
                    <div class="absolute bottom-4 flex gap-2 md:gap-3 bg-white/90 p-1.5 md:p-2 rounded-xl shadow-lg backdrop-blur border border-white z-20">
                        <button onclick="downloadImage()" class="p-2 hover:bg-green-50 rounded-lg text-slate-600 hover:text-green-700" title="ä¸‹è¼‰/åˆ†äº«"><i data-lucide="download" class="w-5 h-5"></i></button>
                        <button onclick="useAsReference()" class="p-2 hover:bg-blue-50 rounded-lg text-slate-600 hover:text-blue-600" title="é‡ç¹ª"><i data-lucide="refresh-ccw" class="w-5 h-5"></i></button>
                        <button onclick="copyToClipboard()" class="p-2 hover:bg-yellow-50 rounded-lg text-slate-600 hover:text-yellow-600" title="è¤‡è£½"><i data-lucide="copy" class="w-5 h-5"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="h-24 md:h-36 bg-white border-t border-slate-200 p-3 md:p-4 shrink-0 flex items-center gap-3 md:gap-4 overflow-x-auto no-scrollbar shadow-inner z-10" id="gallery">
                <div class="text-xs md:text-sm text-slate-400 font-medium italic px-2 md:px-6 flex flex-col md:flex-row items-center gap-1 md:gap-2 text-center whitespace-nowrap">
                    <i data-lucide="history" class="w-4 h-4"></i> <span>æ­·å²ç´€éŒ„</span>
                </div>
            </div>
        </section>
    </main>

    <div id="lightbox" class="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-2 hidden" onclick="closeLightbox()">
        <button class="absolute top-4 right-4 text-white/70 hover:text-white p-2">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>
        <img id="lightboxImage" src="" class="max-w-full max-h-[90vh] object-contain">
    </div>

    <!-- Notification Toast -->
    <div id="toast" onclick="dismissToast()" class="fixed top-4 right-4 md:top-6 md:right-6 bg-white border-l-4 border-yellow-400 text-slate-800 px-4 py-3 md:px-6 md:py-4 rounded-r-lg shadow-2xl transform translate-x-full transition-transform duration-300 z-[100] flex items-center gap-3 md:gap-4 max-w-[90vw] md:min-w-[300px] cursor-pointer">
        <div id="toastIconContainer" class="p-1.5 md:p-2 bg-slate-50 rounded-full shrink-0"><i data-lucide="info" id="toastIcon" class="w-4 h-4 md:w-5 md:h-5 text-slate-500"></i></div>
        <div>
            <h4 class="font-bold text-xs md:text-sm text-slate-900" id="toastTitle">é€šçŸ¥</h4>
            <span id="toastMsg" class="text-xs md:text-sm text-slate-500 line-clamp-2">Message body</span>
        </div>
    </div>

    <script>
        // --- 1. FULL Data Restored ---
        const taxonomyData = {
            "æ§‹åœ– (Composition)": {
                icon: "crop", color: "purple",
                items: [
                    { tag: "Full body shot", label: "ğŸ§ å…¨èº«æ§‹åœ–", desc: "ç¢ºä¿å¾é ­åˆ°è…³éƒ½å®Œæ•´" },
                    { tag: "Upper body shot", label: "ğŸ‘¤ åŠèº«æ§‹åœ–", desc: "å°ˆæ³¨æ–¼è…°éƒ¨ä»¥ä¸Š" },
                    { tag: "Wide shot, environmental", label: "ğŸï¸ å»£è§’å¤§æ™¯", desc: "äººå°æ™¯å¤§ï¼Œå¼·èª¿ç’°å¢ƒ" },
                    { tag: "Action shot, dynamic pose", label: "ğŸƒ å‹•æ…‹ç¬é–“", desc: "æ•æ‰é«˜é€Ÿé‹å‹•ç¬é–“" }
                ]
            },
            "è—è¡“é¢¨æ ¼ (Style)": {
                icon: "palette", color: "green",
                items: [
                    { tag: "Photorealistic, 8k", label: "ğŸ“¸ è¶…å¯«å¯¦", desc: "æ¥µè‡´çœŸå¯¦æ„Ÿ" },
                    { tag: "Cyberpunk style", label: "ğŸ¤– è³½åš", desc: "éœ“è™¹ç§‘æŠ€æ„Ÿ" },
                    { tag: "Anime style", label: "ğŸŒ å‹•æ¼«", desc: "æ—¥ç³»æ‰‹ç¹ªé¢¨" },
                    { tag: "Oil painting", label: "ğŸ¨ æ²¹ç•«", desc: "åšå¡—è³ªæ„Ÿ" },
                    { tag: "3D render", label: "ğŸ§Š 3D", desc: "CGI æ¸²æŸ“è³ªæ„Ÿ" },
                    { tag: "Watercolor", label: "ğŸ’§ æ°´å½©", desc: "æŸ”å’ŒæšˆæŸ“" },
                    { tag: "Pop Art", label: "ğŸ­ æ™®æ™®", desc: "é«˜å°æ¯”è‰²å½©" },
                    { tag: "Pixel art", label: "ğŸ‘¾ åƒç´ ", desc: "å¾©å¤é›»ç©é¢¨" },
                    // Restored Items:
                    { tag: "Steampunk", label: "âš™ï¸ è’¸æ°£", desc: "ç¶­å¤šåˆ©äºæ©Ÿæ¢°é¢¨" },
                    { tag: "Concept Art", label: "ğŸ® æ¦‚å¿µ", desc: "éŠæˆ²è¨­è¨ˆåœ–" },
                    { tag: "Ink Wash Painting", label: "ğŸ–Œï¸ æ°´å¢¨", desc: "æ±æ–¹æ°´å¢¨ç•«" },
                    { tag: "Low Poly", label: "ğŸ”· ä½å¤šé‚Šå½¢", desc: "å¹¾ä½•æ¥µç°¡é¢¨" },
                    { tag: "Paper Cut Craft", label: "âœ‚ï¸ å‰ªç´™", desc: "å±¤ç–Šç´™è—" },
                    { tag: "Surrealism", label: "ğŸ‘ï¸ è¶…ç¾å¯¦", desc: "å¤¢å¢ƒå¹»æƒ³" },
                    { tag: "Graffiti", label: "ğŸ¤˜ å¡—é´‰", desc: "è¡—é ­å™´æ¼†" },
                    { tag: "Claymation", label: "ğŸ§± é»åœŸ", desc: "å®šæ ¼å‹•ç•«æ„Ÿ" }
                ]
            },
            "å…‰å½±æ°›åœ (Lighting)": {
                icon: "sun", color: "yellow",
                items: [
                    { tag: "Cinematic lighting", label: "ğŸ¬ é›»å½±", desc: "æˆ²åŠ‡å¼µåŠ›å…‰å½±" },
                    { tag: "Natural sunlight", label: "â˜€ï¸ è‡ªç„¶", desc: "ç™½å¤©æŸ”å’Œå…‰ç·š" },
                    { tag: "Golden hour", label: "ğŸŒ… é»ƒé‡‘", desc: "æ—¥è½æº«æš–å…‰" },
                    { tag: "Neon lighting", label: "ğŸ’¡ éœ“è™¹", desc: "å½©è‰²è¼ªå»“å…‰" },
                    { tag: "Volumetric lighting", label: "ğŸŒ«ï¸ é«”ç©", desc: "è€¶ç©Œå…‰æŸ" },
                    { tag: "Soft pastel lighting", label: "ğŸŒ¸ ç²‰å½©", desc: "å¤¢å¹»æŸ”å…‰" }
                ]
            },
            "é¡é ­è¦–è§’ (Camera)": {
                icon: "camera", color: "blue",
                items: [
                    { tag: "Wide angle", label: "ğŸ”­ å»£è§’", desc: "è¦–é‡æ¥µå¯¬" },
                    { tag: "Macro", label: "ğŸ” å¾®è·", desc: "æ¥µè¿‘è·é›¢ç‰¹å¯«" },
                    { tag: "Bokeh", label: "ğŸŒ«ï¸ æ™¯æ·±", desc: "èƒŒæ™¯æ¨¡ç³Š" },
                    { tag: "Isometric", label: "ğŸ“ 2.5D", desc: "ç­‰è·è¦–è§’" },
                    { tag: "High-angle shot", label: "ğŸ”­ ä¿¯è¦–", desc: "ç”±ä¸Šå¾€ä¸‹æ‹" },
                    { tag: "Low angle shot", label: "â¬‡ï¸ ä»°æ‹", desc: "ç”±ä¸‹å¾€ä¸Šæ‹" }
                ]
            }
        };

        const state = {
            apiKey: '', refImageBase64: null, refImageMimeType: null, history: [],
            currentTab: 'phase1', selectedTags: {}, lastToastData: null, toastTimer: null,
            abortController: null 
        };

        const els = {
            apiKeyInput: document.getElementById('apiKeyInput'),
            mobileApiKeyInput: document.getElementById('mobileApiKeyInput'),
            mobileKeyDrawer: document.getElementById('mobileKeyDrawer'),
            promptInput: document.getElementById('promptInput'),
            builderPrompt: document.getElementById('builderPrompt'),
            imageInput: document.getElementById('imageInput'),
            refImagePreview: document.getElementById('refImagePreview'),
            uploadPlaceholder: document.getElementById('uploadPlaceholder'),
            clearRefBtn: document.getElementById('clearRefBtn'),
            generateBtn: document.getElementById('generateBtn'),
            welcomeState: document.getElementById('welcomeState'),
            loadingState: document.getElementById('loadingState'),
            resultContainer: document.getElementById('resultContainer'),
            generatedImage: document.getElementById('generatedImage'),
            loadingTime: document.getElementById('loadingTime'),
            gallery: document.getElementById('gallery'),
            aspectRatio: document.getElementById('aspectRatio'),
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toastMsg'),
            toastTitle: document.getElementById('toastTitle'),
            toastIcon: document.getElementById('toastIcon'),
            tab1: document.getElementById('tab-phase1'),
            tab2: document.getElementById('tab-phase2'),
            selectedTagsPreview: document.getElementById('selectedTagsPreview'),
            tagCountBadge: document.getElementById('tagCountBadge'),
            taxonomyContainer: document.getElementById('taxonomyContainer'),
            lightbox: document.getElementById('lightbox'),
            lightboxImage: document.getElementById('lightboxImage'),
            anatomyFixCheck: document.getElementById('anatomyFixCheck')
        };

        document.addEventListener('DOMContentLoaded', () => {
            renderTaxonomy(); 
            lucide.createIcons();
            loadApiKey();
            setupDragAndDrop();
            switchTab('phase1');
        });

        // --- Logic ---
        function toggleMobileKeyInput() {
            els.mobileKeyDrawer.classList.toggle('hidden');
            if (!els.mobileKeyDrawer.classList.contains('hidden')) els.mobileApiKeyInput.focus();
        }

        function checkMobileKeyEnter(event) {
            if (event.key === 'Enter') { event.preventDefault(); saveMobileKey(); }
        }

        function saveMobileKey() {
            const key = els.mobileApiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                state.apiKey = key;
                els.apiKeyInput.value = key; 
                showToast('API Key å·²å„²å­˜', 'success');
                toggleMobileKeyInput();
                els.mobileApiKeyInput.blur();
            }
        }

        function renderTaxonomy() {
            els.taxonomyContainer.innerHTML = '';
            Object.entries(taxonomyData).forEach(([catName, catData]) => {
                const section = document.createElement('div');
                section.innerHTML = `
                    <h3 class="text-green-800 text-sm md:text-base font-bold mb-3 flex items-center gap-2 border-b-2 border-green-100 pb-2">
                        <span class="bg-${catData.color}-100 p-1 rounded-lg"><i data-lucide="${catData.icon}" class="w-4 h-4 text-${catData.color}-600"></i></span>
                        ${catName}
                    </h3>
                    <div class="grid grid-cols-3 md:grid-cols-4 gap-2 mb-6"></div>
                `;
                const grid = section.querySelector('.grid');
                catData.items.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'tag-btn p-2 rounded-lg text-left text-xs md:text-sm relative group/btn h-full flex items-center';
                    btn.textContent = item.label;
                    btn.onclick = () => toggleTag(btn, catName, item.tag);
                    grid.appendChild(btn);
                });
                els.taxonomyContainer.appendChild(section);
            });
        }

        function switchTab(tabId) {
            state.currentTab = tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabId}`).classList.add('active');
            
            const activeClass = ['bg-yellow-400', 'text-green-900', 'shadow-md'];
            const inactiveClass = ['text-green-100']; 

            if (tabId === 'phase1') {
                els.tab1.classList.add(...activeClass);
                els.tab2.classList.remove(...activeClass);
                els.tab2.classList.add(...inactiveClass);
            } else {
                els.tab2.classList.add(...activeClass);
                els.tab1.classList.remove(...activeClass);
                els.tab1.classList.add(...inactiveClass);
            }
        }

        function toggleTag(btn, category, tag) {
            if (state.selectedTags[category] === tag) {
                delete state.selectedTags[category];
                btn.classList.remove('active');
            } else {
                state.selectedTags[category] = tag;
                const buttons = btn.parentElement.querySelectorAll('button');
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateTagPreview();
        }

        function updateTagPreview() {
            const tags = Object.values(state.selectedTags).filter(Boolean);
            els.tagCountBadge.textContent = tags.length > 0 ? `å·²é¸ ${tags.length}` : 'å·²é¸ 0';
            els.selectedTagsPreview.textContent = tags.length > 0 ? tags.join(', ') : '(å°šæœªé¸æ“‡)';
        }

        function transferToPhase2() {
            const basePrompt = els.builderPrompt.value.trim();
            const tags = Object.values(state.selectedTags).filter(Boolean).join(', ');
            let finalPrompt = basePrompt;
            if (basePrompt && tags) finalPrompt = `${basePrompt}, ${tags}`;
            else if (tags) finalPrompt = tags;
            els.promptInput.value = finalPrompt;
            switchTab('phase2');
        }

        async function generateImage() {
            if (!state.apiKey) { showToast('è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ API Key', 'error'); return; }
            if (!els.promptInput.value.trim()) { showToast('è«‹è¼¸å…¥æç¤ºè©', 'warning'); return; }

            if (state.abortController) state.abortController.abort();
            state.abortController = new AbortController();
            const signal = state.abortController.signal;
            const timeoutId = setTimeout(() => state.abortController.abort(), 60000); 

            setLoading(true);
            const startTime = Date.now();
            const timer = setInterval(() => { els.loadingTime.textContent = ((Date.now() - startTime) / 1000).toFixed(1) + 's'; }, 100);

            try {
                const model = 'gemini-3-pro-image-preview';
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${state.apiKey}`;
                
                let anatomyFix = "";
                if (els.anatomyFixCheck && els.anatomyFixCheck.checked) {
                    anatomyFix = ", perfect anatomy, realistic proportions, high quality";
                }
                
                const safePrompt = els.promptInput.value + anatomyFix + ` (Aspect Ratio: ${els.aspectRatio.value})`;
                const parts = [{ text: safePrompt }];
                if (state.refImageBase64) {
                    const base64Data = state.refImageBase64.split(',')[1];
                    const mimeType = state.refImageMimeType || 'image/png';
                    parts.push({ inline_data: { mime_type: mimeType, data: base64Data } });
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: parts }] }),
                    signal: signal
                });

                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error?.message || 'API Error');

                let imageBase64 = null;
                if (data.candidates?.[0]?.content?.parts) {
                     const part = data.candidates[0].content.parts.find(p => p.inline_data || (p.inlineData));
                     if (part) {
                         const inline = part.inline_data || part.inlineData;
                         imageBase64 = `data:${inline.mime_type};base64,${inline.data}`;
                     }
                }
                if (!imageBase64 && data.predictions?.[0]?.bytesBase64Encoded) {
                    imageBase64 = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                }

                if (imageBase64) {
                    displayResult(imageBase64);
                    addToHistory(imageBase64, els.promptInput.value);
                    showToast('ç”ŸæˆæˆåŠŸï¼', 'success');
                } else {
                    throw new Error('æœªæ‰¾åˆ°åœ–ç‰‡æ•¸æ“š');
                }
            } catch (error) {
                if (error.name === 'AbortError') showToast('è«‹æ±‚é€¾æ™‚', 'error');
                else showToast(`éŒ¯èª¤: ${error.message}`, 'error');
            } finally {
                clearTimeout(timeoutId);
                clearInterval(timer);
                setLoading(false);
            }
        }

        // --- FIXED: Mobile Friendly Download ---
        async function downloadImage() {
            if (!els.generatedImage.src) return;
            const src = els.generatedImage.src;

            // Strategy 1: Web Share API (Best for Mobile)
            if (navigator.share && navigator.canShare) {
                try {
                    // Need to convert Data URI to Blob for sharing
                    const response = await fetch(src);
                    const blob = await response.blob();
                    const file = new File([blob], "nano-banana.png", { type: blob.type });
                    await navigator.share({ files: [file] });
                    return;
                } catch (e) {
                    console.log('Share failed/cancelled', e);
                    // Fallback if share fails (e.g. user cancelled)
                }
            }

            // Strategy 2: Anchor Tag (Desktop / Fallback)
            const a = document.createElement('a');
            a.href = src;
            a.download = `nano-banana-${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function displayResult(src) {
            els.generatedImage.src = src;
            els.welcomeState.classList.add('hidden');
            els.resultContainer.classList.remove('hidden');
        }

        function setLoading(isLoading) {
            els.generateBtn.disabled = isLoading;
            els.generateBtn.innerHTML = isLoading ? '<div class="loader w-4 h-4 border-2"></div> ç”Ÿæˆä¸­...' : '<i data-lucide="zap" class="w-4 h-4"></i> é–‹å§‹ç”Ÿæˆ';
            lucide.createIcons();
            els.loadingState.classList.toggle('hidden', !isLoading);
        }

        function setupDragAndDrop() {
            const dz = document.getElementById('dropZone');
            els.imageInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) { showToast('è«‹ä¸Šå‚³åœ–ç‰‡', 'error'); return; }
            if (file.size > 5 * 1024 * 1024) { showToast('åœ–ç‰‡éå¤§ (>5MB)', 'error'); return; }

            const reader = new FileReader();
            reader.onload = (e) => {
                state.refImageBase64 = e.target.result;
                state.refImageMimeType = file.type;
                els.refImagePreview.src = state.refImageBase64;
                els.refImagePreview.classList.remove('hidden');
                els.uploadPlaceholder.classList.add('hidden');
                els.clearRefBtn.classList.remove('hidden');
                showToast('åƒè€ƒåœ–å·²è¼‰å…¥', 'success');
            };
            reader.readAsDataURL(file);
        }

        function clearRefImage() {
            state.refImageBase64 = null;
            els.imageInput.value = '';
            els.refImagePreview.classList.add('hidden');
            els.uploadPlaceholder.classList.remove('hidden');
            els.clearRefBtn.classList.add('hidden');
        }

        function addToHistory(url, prompt) {
            const item = { url, prompt, id: Date.now() };
            state.history.unshift(item);
            if (state.history.length > 10) state.history.pop();
            renderGallery();
        }

        function renderGallery() {
            els.gallery.innerHTML = '';
            const header = document.createElement('div');
            header.className = 'text-xs md:text-sm text-slate-400 font-medium italic px-2 md:px-6 flex flex-col items-center gap-1 shrink-0';
            header.innerHTML = '<i data-lucide="history" class="w-4 h-4"></i><span>æ­·å²</span>';
            els.gallery.appendChild(header);

            state.history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'w-16 h-16 md:w-24 md:h-24 shrink-0 rounded-lg overflow-hidden border border-slate-200 cursor-pointer relative';
                const img = document.createElement('img');
                img.src = item.url;
                img.className = 'w-full h-full object-cover';
                div.appendChild(img);
                div.onclick = () => { displayResult(item.url); els.promptInput.value = item.prompt; };
                els.gallery.appendChild(div);
            });
            lucide.createIcons();
        }

        function useAsReference() {
            if (!els.generatedImage.src) return;
            const src = els.generatedImage.src;
            state.refImageBase64 = src;
            const match = src.match(/^data:(image\/[a-zA-Z+]+);base64,/);
            state.refImageMimeType = match ? match[1] : 'image/png';
            els.refImagePreview.src = state.refImageBase64;
            els.refImagePreview.classList.remove('hidden');
            els.uploadPlaceholder.classList.add('hidden');
            els.clearRefBtn.classList.remove('hidden');
            showToast('å·²è¨­ç‚ºåƒè€ƒåœ–', 'success');
        }

        async function copyToClipboard() {
             if (!els.generatedImage.src) return;
             try {
                 const response = await fetch(els.generatedImage.src);
                 const blob = await response.blob();
                 await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
                 showToast('å·²è¤‡è£½', 'success');
             } catch (err) { console.error(err); showToast('è¤‡è£½å¤±æ•—', 'error'); }
        }

        function saveApiKey() {
            const key = els.apiKeyInput.value.trim();
            if (key) { 
                localStorage.setItem('gemini_api_key', key); 
                state.apiKey = key; 
                showToast('Key å·²å„²å­˜', 'success'); 
            }
        }

        function loadApiKey() {
            const key = localStorage.getItem('gemini_api_key');
            if (key) { 
                els.apiKeyInput.value = key; 
                els.mobileApiKeyInput.value = key;
                state.apiKey = key; 
            }
        }

        function toggleApiKeyVisibility() { els.apiKeyInput.type = els.apiKeyInput.type === 'password' ? 'text' : 'password'; }

        function showToast(msg, type = 'info') {
            state.lastToastData = { msg, type }; 
            els.toastMsg.textContent = msg;
            els.toast.classList.remove('translate-x-full');
            
            if (type === 'success') {
                els.toast.classList.add('border-green-500');
                els.toastTitle.textContent = 'æˆåŠŸ';
                els.toastIcon.setAttribute('data-lucide', 'check');
            } else if (type === 'error') {
                els.toast.classList.add('border-red-500');
                els.toastTitle.textContent = 'éŒ¯èª¤';
                els.toastIcon.setAttribute('data-lucide', 'alert-triangle');
            }
            lucide.createIcons();

            if (state.toastTimer) clearTimeout(state.toastTimer);
            if (type !== 'error') {
                state.toastTimer = setTimeout(() => {
                    els.toast.classList.add('translate-x-full');
                }, 3000);
            }
        }

        function dismissToast() { els.toast.classList.add('translate-x-full'); }
        function showLastToast() { if (state.lastToastData) showToast(state.lastToastData.msg, state.lastToastData.type); }
        function openLightbox() { if (!els.generatedImage.src) return; els.lightboxImage.src = els.generatedImage.src; els.lightbox.classList.remove('hidden'); }
        function closeLightbox() { els.lightbox.classList.add('hidden'); }
    </script>
</body>
</html>
