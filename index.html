<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana Studio | AI Image Generator</title>

    <!-- Meta Tags for SEO & Sharing -->
    <meta name="description"
        content="A zero-setup, single-file AI image generation studio powered by Google Gemini 3 Pro. No backend required.">
    <meta property="og:title" content="Nano Banana Studio">
    <meta property="og:description" content="é‡‹æ”¾ Gemini 3 Pro çš„åœ–åƒç”Ÿæˆæ½›åŠ›ã€‚å…å®‰è£ã€å–®ä¸€æª”æ¡ˆã€å³é–‹å³ç”¨ã€‚">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://emojicdn.elk.sh/ğŸŒ"> <!-- Placeholder image -->

    <!-- Favicon (Emoji Trick) -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #15803d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #14532d;
        }

        .loader {
            border: 4px solid #e2e8f0;
            border-radius: 50%;
            border-top: 4px solid #facc15;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Tag Button Styles */
        .tag-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #e2e8f0;
            background-color: #ffffff;
            color: #334155;
            font-weight: 500;
        }

        .tag-btn:hover {
            border-color: #facc15;
            background-color: #fefce8;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .tag-btn.active {
            border-color: #15803d;
            background-color: #dcfce7;
            color: #166534;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            font-weight: 700;
            position: relative;
        }

        .tag-btn.active::after {
            content: 'âœ“';
            position: absolute;
            top: 4px;
            right: 8px;
            font-size: 10px;
            color: #15803d;
        }

        .tag-btn:active {
            transform: scale(0.95);
        }

        /* Tab Animation */
        .tab-content {
            display: none;
            opacity: 0;
            width: 100%;
            flex-grow: 1;
            transition: opacity 0.2s ease-in-out;
        }

        .tab-content.active {
            display: flex;
            opacity: 1;
        }

        #styleTooltip {
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
        }

        /* Lightbox */
        #lightbox {
            transition: opacity 0.3s ease;
        }

        #lightbox.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #lightbox:not(.hidden) {
            opacity: 1;
            pointer-events: auto;
        }

        #lightbox img {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Checkbox Custom Style */
        .custom-checkbox:checked {
            background-color: #15803d;
            border-color: #15803d;
        }

        .custom-checkbox:checked+div {
            color: #15803d;
            font-weight: 700;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden selection:bg-yellow-300 selection:text-green-900">

    <!-- Header -->
    <header
        class="h-16 bg-green-800 border-b-4 border-yellow-400 flex items-center justify-between px-4 md:px-6 shrink-0 z-50 shadow-md gap-4">
        <!-- Left: Logo -->
        <div class="flex items-center gap-3 shrink-0">
            <div
                class="w-10 h-10 bg-yellow-400 rounded-xl flex items-center justify-center text-green-900 font-black text-2xl shadow-sm rotate-3 hover:rotate-12 transition-transform cursor-default">
                ğŸŒ</div>
            <h1 class="text-xl font-bold text-white tracking-wide hidden md:block">Nano Banana <span
                    class="text-yellow-300">Studio</span></h1>
        </div>

        <!-- Center: Nav -->
        <nav class="flex-1 flex justify-center min-w-0">
            <div
                class="flex bg-green-900/50 p-1.5 rounded-full border border-green-600/30 backdrop-blur-sm whitespace-nowrap">
                <button onclick="switchTab('phase1')" id="tab-phase1"
                    class="px-3 md:px-6 py-1.5 rounded-full text-sm font-bold transition-all duration-300 flex items-center gap-2">
                    <i data-lucide="beaker" class="w-4 h-4"></i> <span class="hidden sm:inline">éˆæ„Ÿå¯¦é©—å®¤</span>
                </button>
                <button onclick="switchTab('phase2')" id="tab-phase2"
                    class="px-3 md:px-6 py-1.5 rounded-full text-sm font-bold transition-all duration-300 flex items-center gap-2">
                    <i data-lucide="image" class="w-4 h-4"></i> <span class="hidden sm:inline">å½±åƒå·¥ä½œå®¤</span>
                </button>
            </div>
        </nav>

        <!-- Right: Controls -->
        <div class="flex items-center gap-2 md:gap-3 shrink-0">
            <!-- GitHub Link (Replace # with your URL) -->
            <a href="#" target="_blank"
                class="p-2 rounded-full bg-green-700/50 hover:bg-black hover:text-white text-green-100 transition relative group hidden sm:flex"
                title="View on GitHub">
                <i data-lucide="github" class="w-5 h-5"></i>
            </a>

            <button onclick="showLastToast()"
                class="p-2 rounded-full bg-green-700/50 hover:bg-green-600 text-green-100 hover:text-white transition relative group"
                title="é¡¯ç¤ºæœ€å¾Œé€šçŸ¥">
                <i data-lucide="bell" class="w-5 h-5"></i>
            </button>

            <div class="relative group hidden md:block">
                <input type="password" id="apiKeyInput" placeholder="è¼¸å…¥ Google API Key" autocomplete="new-password"
                    class="bg-green-700/50 border border-green-600 text-white placeholder-green-200/70 text-sm rounded-lg px-4 py-2 w-32 lg:w-48 focus:outline-none focus:bg-green-700 focus:border-yellow-400 transition-all shadow-inner"
                    title="Key åƒ…å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨æœ¬åœ°ç«¯ï¼Œä¸æœƒä¸Šå‚³è‡³ä»»ä½•ä¼ºæœå™¨">
                <div class="absolute right-3 top-2.5 text-green-200 cursor-pointer hover:text-white"
                    onclick="toggleApiKeyVisibility()"><i data-lucide="eye" class="w-4 h-4"></i></div>
            </div>

            <button onclick="clearAllData()"
                class="p-2 rounded-full bg-red-900/30 hover:bg-red-600 text-red-200 hover:text-white transition relative group"
                title="ç™»å‡ºä¸¦æ¸…é™¤æ‰€æœ‰è³‡æ–™">
                <i data-lucide="log-out" class="w-5 h-5"></i>
            </button>

            <button onclick="saveApiKey()"
                class="text-xs bg-green-900 hover:bg-green-700 text-yellow-300 font-bold px-3 py-2.5 rounded-lg transition border border-green-700 whitespace-nowrap">å„²å­˜
                Key</button>
        </div>
    </header>

    <!-- Phase 1: éˆæ„Ÿå¯¦é©—å®¤ -->
    <main id="view-phase1" class="tab-content active w-full overflow-hidden bg-slate-50 flex-col md:flex-row relative">
        <!-- LEFT COLUMN -->
        <div class="flex-1 overflow-y-auto p-6 md:p-8 space-y-10 bg-white order-2 md:order-1 relative"
            id="styleContainer">
            <div class="mb-6">
                <h2 class="text-2xl font-black text-slate-800 flex items-center gap-2"><span class="text-3xl">ğŸ¨</span>
                    é¢¨æ ¼å¯¦é©—å®¤</h2>
                <p class="text-slate-500 text-sm mt-1">æ¯ä¸€é¡åˆ¥åƒ…èƒ½é¸æ“‡ä¸€ç¨®é¢¨æ ¼ï¼Œé¿å…æŒ‡ä»¤è¡çªã€‚</p>
            </div>
            <div id="taxonomyContainer"></div>
            <!-- Footer in Scroll Area -->
            <div class="h-24 flex items-end justify-center pb-8">
                <p class="text-slate-300 text-xs font-medium">Nano Banana Studio v1.6 â€¢ Open Source on GitHub</p>
            </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div
            class="w-full md:w-[350px] lg:w-[420px] shrink-0 bg-slate-50 border-l border-slate-200 flex flex-col order-1 md:order-2 z-20 h-[40vh] md:h-full">
            <div
                class="p-4 border-b border-slate-200 bg-white/50 backdrop-blur-sm shrink-0 flex justify-between items-center">
                <label class="text-green-700 text-xs font-black uppercase tracking-widest flex items-center gap-2">
                    <span class="bg-yellow-300 text-green-900 px-2 py-0.5 rounded text-[10px]">STEP 1</span>
                    å’’èªè¼¸å…¥ (Prompt)
                </label>
            </div>

            <div class="flex-1 p-4 flex flex-col gap-4 overflow-hidden">
                <textarea id="builderPrompt"
                    class="w-full flex-1 bg-white border-2 border-slate-200 rounded-xl p-4 text-base text-slate-800 font-medium focus:outline-none focus:border-yellow-400 focus:ring-2 focus:ring-yellow-100 transition-all resize-none placeholder-slate-400"
                    placeholder="åœ¨æ­¤è¼¸å…¥ä¸»è¦æè¿°... (ä¾‹å¦‚ï¼šä¸€éš»æˆ´è‘—å¢¨é¡çš„é³³æ¢¨)"></textarea>

                <div class="shrink-0">
                    <label
                        class="flex items-center gap-3 p-3 bg-indigo-50 border border-indigo-100 rounded-xl cursor-pointer hover:bg-indigo-100 transition-colors group/check">
                        <input type="checkbox" id="anatomyFixCheck"
                            class="custom-checkbox w-5 h-5 border-2 border-indigo-300 rounded text-indigo-600 focus:ring-indigo-500 cursor-pointer">
                        <div class="text-sm text-indigo-700 transition-colors">
                            <span class="block font-bold flex items-center gap-2"><i data-lucide="sparkles"
                                    class="w-4 h-4"></i> å¼·åˆ¶ä¿®å¾©äººé«”/ç´°ç¯€</span>
                        </div>
                    </label>
                </div>

                <div class="shrink-0 bg-green-50 rounded-lg p-3 border border-green-100">
                    <div class="text-[10px] uppercase font-bold text-green-600 mb-1 flex items-center justify-between">
                        <span>å·²é¸é¢¨æ ¼ (Active Tags)</span>
                        <span id="tagCountBadge" class="bg-green-200 text-green-800 px-1.5 rounded-full">0</span>
                    </div>
                    <div id="selectedTagsPreview"
                        class="text-xs text-slate-500 italic h-8 overflow-y-auto leading-relaxed">
                        (å°šæœªé¸æ“‡ä»»ä½•é¢¨æ ¼)
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-200 bg-white shrink-0">
                <button onclick="transferToPhase2()"
                    class="w-full bg-yellow-400 hover:bg-yellow-300 text-green-900 font-black px-6 py-4 rounded-xl flex items-center justify-center gap-2 shadow-[0_4px_0_rgb(202,138,4)] hover:shadow-[0_2px_0_rgb(202,138,4)] hover:translate-y-[2px] transition-all">
                    çµ„åˆä¸¦å»ç”Ÿæˆ <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <div id="styleTooltip"
            class="fixed hidden z-50 bg-slate-800 text-white p-4 rounded-xl shadow-2xl max-w-xs border border-slate-600 pointer-events-none">
            <h4 id="tooltipTitle" class="font-bold text-yellow-400 text-lg mb-1">Title</h4>
            <p id="tooltipDesc" class="text-xs text-slate-300 leading-relaxed">Description goes here.</p>
        </div>
    </main>

    <!-- Phase 2: å½±åƒå·¥ä½œå®¤ -->
    <main id="view-phase2" class="tab-content w-full flex-row overflow-hidden bg-slate-100">
        <aside
            class="w-80 md:w-96 bg-white border-r border-slate-200 flex flex-col overflow-y-auto p-6 gap-6 shrink-0 shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10">
            <div class="space-y-2">
                <label
                    class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center justify-between">
                    <span class="flex items-center gap-2 text-green-700"><i data-lucide="sparkles"
                            class="w-4 h-4 text-yellow-500"></i> æœ€çµ‚æç¤ºè©</span>
                    <button onclick="switchTab('phase1')"
                        class="text-[10px] text-green-600 hover:text-green-800 font-bold hover:underline bg-green-50 px-2 py-1 rounded">â†
                        å›å¯¦é©—å®¤</button>
                </label>
                <textarea id="promptInput" rows="6"
                    class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-3 text-sm focus:outline-none focus:border-yellow-400 focus:bg-white transition-colors resize-none placeholder-slate-400 text-slate-700"></textarea>
            </div>

            <div class="space-y-2">
                <label
                    class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center justify-between">
                    <span class="flex items-center gap-2"><i data-lucide="image" class="w-4 h-4 text-blue-500"></i> åƒè€ƒåœ–
                        (é¸å¡«)</span>
                    <button onclick="clearRefImage()" id="clearRefBtn"
                        class="hidden text-xs text-red-500 hover:text-red-700 font-bold">æ¸…é™¤ X</button>
                </label>
                <div id="dropZone"
                    class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:border-yellow-400 hover:bg-yellow-50/50 transition relative group bg-slate-50">
                    <input type="file" id="imageInput" accept="image/*"
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    <div id="uploadPlaceholder"
                        class="flex flex-col items-center gap-2 py-2 text-slate-400 group-hover:text-green-700 transition-colors">
                        <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                        <span class="text-xs font-medium">æ‹–æ”¾åœ–ç‰‡æˆ–é»æ“Šä¸Šå‚³</span>
                    </div>
                    <img id="refImagePreview"
                        class="hidden w-full h-auto rounded-lg shadow-md object-contain max-h-48 mx-auto">
                </div>
                <details class="group bg-blue-50 rounded-lg p-3 text-xs text-slate-600 open:ring-2 open:ring-blue-100">
                    <summary
                        class="cursor-pointer font-bold text-blue-700 flex items-center gap-1 list-none select-none">
                        <i data-lucide="info" class="w-3 h-3"></i> é—œæ–¼åƒè€ƒåœ–èˆ‡é¢¨æ ¼è¡çª
                        <span class="ml-auto transition-transform group-open:rotate-180">â–¼</span>
                    </summary>
                    <div class="mt-2 pl-4 border-l-2 border-blue-200 space-y-2 leading-relaxed">
                        <p>1. <span class="font-bold text-blue-800">å„ªå…ˆç´š</span>ï¼šæç¤ºè©é¢¨æ ¼ > åƒè€ƒåœ–é¢¨æ ¼ã€‚</p>
                        <p>2. <span class="font-bold text-blue-800">ä½œç”¨</span>ï¼šåƒè€ƒæ§‹åœ–èˆ‡é¡è‰²ã€‚</p>
                    </div>
                </details>
            </div>

            <div class="space-y-4 pt-6 border-t border-slate-100">
                <!-- Aspect Ratio -->
                <div>
                    <label class="text-xs font-bold text-slate-400 block mb-2">é•·å¯¬æ¯” (Ratio)</label>
                    <div class="relative">
                        <select id="aspectRatio"
                            class="w-full appearance-none bg-slate-50 border-2 border-slate-200 text-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-green-500 cursor-pointer font-medium">
                            <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                            <option value="16:9">16:9 (é¢¨æ™¯)</option>
                            <option value="9:16">9:16 (æ‰‹æ©Ÿ)</option>
                            <option value="4:3">4:3 (æ¨™æº–)</option>
                            <option value="3:4">3:4 (ç›´å¼)</option>
                        </select>
                        <i data-lucide="chevron-down"
                            class="absolute right-3 top-3 w-4 h-4 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
            </div>

            <div class="mt-auto pt-6">
                <button id="generateBtn" onclick="generateImage()"
                    class="w-full bg-yellow-400 hover:bg-yellow-300 text-green-900 font-black py-4 rounded-xl shadow-[0_4px_0_rgb(202,138,4)] active:shadow-none active:translate-y-[4px] flex items-center justify-center gap-2 transition-all transform group">
                    <i data-lucide="zap" class="w-5 h-5 group-hover:scale-110 transition-transform"></i> é–‹å§‹ç”Ÿæˆ
                </button>
            </div>
        </aside>

        <section class="flex-1 flex flex-col bg-slate-100 relative min-w-0">
            <div class="flex-1 flex items-center justify-center p-8 overflow-hidden relative" id="canvasContainer">
                <div class="absolute inset-0 opacity-[0.03] pointer-events-none"
                    style="background-image: radial-gradient(#15803d 1px, transparent 1px); background-size: 24px 24px;">
                </div>

                <div id="welcomeState" class="text-center text-slate-400 max-w-md relative z-10">
                    <div class="mb-6 inline-block p-8 rounded-full bg-white border-4 border-slate-100 shadow-sm"><i
                            data-lucide="palette" class="w-16 h-16 text-yellow-400"></i></div>
                    <h2 class="text-2xl font-bold text-slate-700 mb-2">æº–å‚™å¥½å‰µä½œäº†å—ï¼Ÿ</h2>
                    <p class="text-slate-500">è«‹ç¢ºèªå·¦å´æç¤ºè©èˆ‡ç•«è³ªè¨­å®šï¼Œé»æ“Šã€Œé–‹å§‹ç”Ÿæˆã€ã€‚</p>
                </div>

                <div id="loadingState"
                    class="hidden absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center backdrop-blur-sm">
                    <div class="loader mb-6"></div>
                    <p class="text-green-700 font-bold text-lg animate-pulse">æ­£åœ¨èª¿è£½å¥ˆç±³é¦™è•‰...</p>
                    <p class="text-slate-400 font-mono text-sm mt-2 bg-slate-100 px-3 py-1 rounded-full"
                        id="loadingTime">0.0s</p>
                </div>

                <div id="resultContainer"
                    class="hidden relative group w-full h-full flex items-center justify-center p-4">
                    <div class="relative max-w-full max-h-full cursor-zoom-in" onclick="openLightbox()">
                        <img id="generatedImage"
                            class="max-w-full max-h-full rounded-lg shadow-2xl object-contain border-4 border-white bg-[url('https://www.transparenttextures.com/patterns/checkerboard-white.png')]"
                            src="" alt="Generated Content">
                        <div
                            class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/20 rounded-lg pointer-events-none">
                            <span
                                class="bg-black/60 text-white text-xs px-3 py-1.5 rounded-full flex items-center gap-1 backdrop-blur-sm">
                                <i data-lucide="maximize-2" class="w-3 h-3"></i> é»æ“Šæ”¾å¤§
                            </span>
                        </div>
                    </div>

                    <div
                        class="absolute bottom-8 flex gap-3 opacity-0 group-hover:opacity-100 transition-all duration-300 translate-y-4 group-hover:translate-y-0 bg-white/90 p-2 rounded-2xl shadow-xl backdrop-blur border border-white z-20">
                        <button onclick="downloadImage()"
                            class="p-3 hover:bg-green-50 rounded-xl text-slate-600 hover:text-green-700 transition tooltip"
                            title="ä¸‹è¼‰å¤§åœ– (Original)"><i data-lucide="download" class="w-6 h-6"></i></button>
                        <button onclick="useAsReference()"
                            class="p-3 hover:bg-blue-50 rounded-xl text-slate-600 hover:text-blue-600 transition tooltip"
                            title="ç”¨ä½œåƒè€ƒåœ– (Remix)"><i data-lucide="refresh-ccw" class="w-6 h-6"></i></button>
                        <button onclick="copyToClipboard()"
                            class="p-3 hover:bg-yellow-50 rounded-xl text-slate-600 hover:text-yellow-600 transition tooltip"
                            title="è¤‡è£½åœ–ç‰‡"><i data-lucide="copy" class="w-6 h-6"></i></button>
                    </div>
                </div>
            </div>

            <div class="h-36 bg-white border-t border-slate-200 p-4 shrink-0 flex items-center gap-4 overflow-x-auto shadow-[0_-4px_24px_rgba(0,0,0,0.03)] z-10"
                id="gallery">
                <div class="text-sm text-slate-400 font-medium italic px-6 flex items-center gap-2">
                    <i data-lucide="history" class="w-4 h-4"></i> æ­·å²è¨˜éŒ„ <span
                        class="text-xs text-slate-300 ml-1">(é‡æ–°æ•´ç†å¾Œæ¸…ç©º)</span>
                </div>
            </div>
        </section>
    </main>

    <div id="lightbox" class="fixed inset-0 z-[100] bg-slate-900/95 flex items-center justify-center p-4 hidden"
        onclick="closeLightbox()">
        <button class="absolute top-6 right-6 text-white/50 hover:text-white transition p-2 bg-white/10 rounded-full">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>
        <img id="lightboxImage" src=""
            class="max-w-full max-h-[90vh] object-contain rounded shadow-2xl scale-95 opacity-0 transition-all duration-300">
    </div>

    <!-- Notification Toast (Click to Dismiss if Error) -->
    <div id="toast" onclick="dismissToast()"
        class="fixed top-6 right-6 bg-white border-l-4 border-yellow-400 text-slate-800 px-6 py-4 rounded-r-lg shadow-2xl transform translate-x-full transition-transform duration-300 z-[100] flex items-center gap-4 min-w-[300px] cursor-pointer">
        <div id="toastIconContainer" class="p-2 bg-slate-50 rounded-full"><i data-lucide="info" id="toastIcon"
                class="text-slate-500"></i></div>
        <div>
            <h4 class="font-bold text-sm text-slate-900" id="toastTitle">é€šçŸ¥</h4>
            <span id="toastMsg" class="text-sm text-slate-500">Message body</span>
        </div>
    </div>

    <script>
        console.log("%cNano Banana Studio ğŸŒ", "color: #fbbf24; font-size: 20px; font-weight: bold;");
        console.log("Welcome, developer! This project is open source.");

        const taxonomyData = {
            "æ§‹åœ– (Composition)": {
                icon: "crop", color: "purple",
                items: [
                    { tag: "Full body shot", label: "ğŸ§ å…¨èº«æ§‹åœ–", desc: "ç¢ºä¿å¾é ­åˆ°è…³éƒ½å®Œæ•´åŒ…å«åœ¨ç•«é¢å…§ï¼Œä¸æœƒåˆ‡åˆ°è…³éƒ¨ã€‚" },
                    { tag: "Upper body shot", label: "ğŸ‘¤ åŠèº«æ§‹åœ–", desc: "å°ˆæ³¨æ–¼è…°éƒ¨ä»¥ä¸Šï¼Œé©åˆå±•ç¾è¡¨æƒ…èˆ‡ä¸ŠåŠèº«å‹•ä½œã€‚" },
                    { tag: "Wide shot, environmental", label: "ğŸï¸ å»£è§’å¤§æ™¯", desc: "äººå°æ™¯å¤§ï¼Œå¼·èª¿ç’°å¢ƒæ°›åœèˆ‡èƒŒæ™¯ç´°ç¯€ã€‚" },
                    { tag: "Action shot, dynamic pose", label: "ğŸƒ å‹•æ…‹ç¬é–“", desc: "æ•æ‰é«˜é€Ÿé‹å‹•ä¸­çš„ç¬é–“ï¼Œå¼·èª¿åŠ›é‡æ„Ÿèˆ‡é€Ÿåº¦ç·šã€‚" }
                ]
            },
            "è—è¡“é¢¨æ ¼ (Style)": {
                icon: "palette", color: "green",
                items: [
                    { tag: "Photorealistic, 8k", label: "ğŸ“¸ è¶…å¯«å¯¦æ”å½±", desc: "å¦‚åŒç”¨é«˜éšå–®çœ¼ç›¸æ©Ÿæ‹æ”ï¼Œè¿½æ±‚æ¥µè‡´çš„çœŸå¯¦æ„Ÿã€æ¯›å­”èˆ‡å…‰å½±ç´°ç¯€ã€‚" },
                    { tag: "Cyberpunk style, neon lights", label: "ğŸ¤– è³½åšé¾å…‹", desc: "é«˜ç§‘æŠ€ä½ç”Ÿæ´»çš„æœªä¾†åçƒæ‰˜é‚¦é¢¨æ ¼ï¼Œå……æ»¿éœ“è™¹ç‡ˆã€æ©Ÿæ¢°ç¾©è‚¢èˆ‡é›¨å¤œè¡—é“ã€‚" },
                    { tag: "Anime style, Studio Ghibli inspired", label: "ğŸŒ æ—¥ç³»å‹•æ¼«", desc: "é¡ä¼¼å®®å´é§¿å‰åœåŠ›å·¥ä½œå®¤çš„æ‰‹ç¹ªé¢¨æ ¼ï¼Œè‰²å½©é£½å’Œã€ç­†è§¸æº«æš–ä¸”å¯Œæœ‰ç«¥è¶£ã€‚" },
                    { tag: "Oil painting, thick impasto", label: "ğŸ¨ æ²¹ç•«è³ªæ„Ÿ", desc: "åšå¡—é¡æ–™çš„è³ªæ„Ÿï¼Œå¼·èª¿ç­†è§¸çš„ç«‹é«”æ„Ÿèˆ‡è‰²å½©çš„å †ç–Šï¼Œå¦‚æ¢µè°·ä½œå“ã€‚" },
                    { tag: "3D render, Octane render", label: "ğŸ§Š 3D æ¸²æŸ“", desc: "é›»è…¦ç”Ÿæˆåœ–åƒ (CGI)ï¼Œå…·æœ‰å®Œç¾çš„å…‰æ»‘è¡¨é¢ã€ç‰©ç†æ­£ç¢ºçš„å…‰ç·šåå°„ã€‚" },
                    { tag: "Watercolor, soft edges", label: "ğŸ’§ æ°´å½©é¢¨æ ¼", desc: "æ°´å½©æšˆæŸ“çš„é€šé€æ„Ÿï¼Œé‚Šç·£æŸ”å’Œï¼Œè‰²å½©æ·¡é›…ï¼Œé©åˆå¤¢å¹»æˆ–æ’ç•«æ°›åœã€‚" },
                    { tag: "Pop Art, vibrant colors", label: "ğŸ­ æ™®æ™®è—è¡“", desc: "é«˜å°æ¯”ã€é®®è±”è‰²å½©ã€é‡è¤‡åœ–å½¢ï¼Œé¡ä¼¼å®‰è¿ªÂ·æ²ƒè·çš„å•†æ¥­è—è¡“é¢¨æ ¼ã€‚" },
                    { tag: "Pixel art, 16-bit", label: "ğŸ‘¾ åƒç´ è—è¡“", desc: "å¾©å¤ 8-bit æˆ– 16-bit é›»ç©é¢¨æ ¼ï¼Œç”±æ˜é¡¯çš„è‰²å¡Šé»é™£çµ„æˆã€‚" },
                    { tag: "Steampunk, brass and gears", label: "âš™ï¸ è’¸æ°£é¾å…‹", desc: "ç¶­å¤šåˆ©äºæ™‚ä»£çš„å·¥æ¥­ç§‘å¹»é¢¨æ ¼ï¼Œå……æ»¿é»ƒéŠ…ã€é½’è¼ªã€è’¸æ°£æ©Ÿæ¢°èˆ‡è­·ç›®é¡å…ƒç´ ã€‚" },
                    { tag: "Concept Art, digital painting", label: "ğŸ® æ¦‚å¿µè—è¡“", desc: "é›»å½±æˆ–éŠæˆ²å‰æœŸè¨­è¨ˆåœ–é¢¨æ ¼ï¼Œç­†è§¸ä¿è½ï¼Œæ§‹åœ–å¤§æ°£ï¼Œå¼·èª¿æ°›åœèˆ‡è¨­è¨ˆæ„Ÿã€‚" },
                    { tag: "Ink Wash Painting, sumi-e", label: "ğŸ–Œï¸ æ°´å¢¨ç•«", desc: "æ±æ–¹å‚³çµ±è—è¡“é¢¨æ ¼ï¼Œåˆ©ç”¨é»‘ç™½å¢¨è‰²çš„æ¿ƒæ·¡è®ŠåŒ–å±•ç¾æ„å¢ƒï¼Œç•™ç™½æ˜¯é‡è¦ç‰¹è‰²ã€‚" },
                    { tag: "Low Poly, geometric", label: "ğŸ”· ä½å¤šé‚Šå½¢", desc: "ç”±å¹¾ä½•å¤šé‚Šå½¢çµ„æˆçš„æ¥µç°¡ 3D é¢¨æ ¼ï¼Œè‰²å½©é®®æ˜ï¼Œå…·æœ‰ç¨ç‰¹çš„ç¨œè§’æ„Ÿã€‚" },
                    { tag: "Paper Cut Craft, layered", label: "âœ‚ï¸ å‰ªç´™è—è¡“", desc: "æ¨¡æ“¬å¤šå±¤ç´™å¼µå †ç–Šçš„æ•ˆæœï¼Œåˆ©ç”¨é™°å½±å‰µé€ æ·±åº¦ï¼Œè³ªæ„Ÿç´°è†©ä¸”å¯Œæœ‰å±¤æ¬¡ã€‚" },
                    { tag: "Surrealism, dreamlike", label: "ğŸ‘ï¸ è¶…ç¾å¯¦ä¸»ç¾©", desc: "å¦‚å¤¢å¢ƒèˆ¬ä¸åˆé‚è¼¯çš„ç•«é¢ï¼Œçµåˆç¾å¯¦èˆ‡å¹»æƒ³ï¼Œåƒé”åˆ©æˆ–é¦¬æ ¼åˆ©ç‰¹çš„ä½œå“ã€‚" },
                    { tag: "Graffiti, street art", label: "ğŸ¤˜ è¡—é ­å¡—é´‰", desc: "åŸå¸‚è¡—é ­é¢¨æ ¼ï¼Œä½¿ç”¨å™´æ¼†è³ªæ„Ÿã€å¤§è†½çš„é…è‰²èˆ‡èª‡å¼µçš„å­—é«”è¨­è¨ˆã€‚" },
                    { tag: "Claymation, stop motion", label: "ğŸ§± é»åœŸå‹•ç•«", desc: "æ¨¡ä»¿é»åœŸæå¡‘çš„å®šæ ¼å‹•ç•«è³ªæ„Ÿï¼Œå…·æœ‰ç¨ç‰¹çš„æ‰‹å·¥ç—•è·¡èˆ‡æè³ªæ„Ÿã€‚" }
                ]
            },
            "å…‰å½±æ°›åœ (Lighting)": {
                icon: "sun", color: "yellow",
                items: [
                    { tag: "Cinematic lighting, dramatic shadows", label: "ğŸ¬ é›»å½±ç´šç‡ˆå…‰", desc: "å¼·èª¿æ˜æš—å°æ¯” (Chiaroscuro)ï¼Œç‡Ÿé€ æˆ²åŠ‡å¼µåŠ›èˆ‡æ•…äº‹æ„Ÿã€‚" },
                    { tag: "Natural sunlight, soft shadows", label: "â˜€ï¸ è‡ªç„¶é™½å…‰", desc: "æ¨¡ä»¿ç™½å¤©çš„è‡ªç„¶å…‰ç·šï¼Œé™°å½±æŸ”å’Œï¼Œçµ¦äººçœŸå¯¦èˆ’é©çš„æ„Ÿè¦ºã€‚" },
                    { tag: "Golden hour, warm tones", label: "ğŸŒ… é»ƒé‡‘æ™‚åˆ»", desc: "æ—¥å‡ºæˆ–æ—¥è½æ™‚åˆ†çš„æº«æš–é‡‘é»ƒè‰²å…‰ç·šï¼Œå……æ»¿æµªæ¼«èˆ‡æ‡·èˆŠæ„Ÿã€‚" },
                    { tag: "Neon lighting, rim light", label: "ğŸ’¡ éœ“è™¹é‚Šç·£å…‰", desc: "ç‰©é«”é‚Šç·£è¢«å½©è‰²å…‰ç·šå‹¾å‹’ï¼ˆè¼ªå»“å…‰ï¼‰ï¼Œå¸¸è¦‹æ–¼ç§‘æŠ€æˆ–å¤œæ™¯ä¸»é¡Œã€‚" },
                    { tag: "Volumetric lighting, god rays", label: "ğŸŒ«ï¸ é«”ç©å…‰", desc: "å…‰ç·šç©¿ééœ§æ°£æˆ–å¡µåŸƒå½¢æˆçš„å¯è¦‹å…‰æŸï¼ˆè€¶ç©Œå…‰ï¼‰ï¼Œå¢åŠ ç©ºé–“çš„ç¥è–æ„Ÿã€‚" },
                    { tag: "Soft pastel lighting", label: "ğŸŒ¸ æŸ”å’Œç²‰å½©å…‰", desc: "ä½å°æ¯”åº¦ã€ç²‰å«©è‰²èª¿çš„å…‰ç·šï¼Œç‡Ÿé€ æº«æŸ”ã€å¤¢å¹»æˆ–å°‘å¥³é¢¨æ ¼ã€‚" }
                ]
            },
            "é¡é ­è¦–è§’ (Camera)": {
                icon: "camera", color: "blue",
                items: [
                    { tag: "Wide angle lens, fisheye", label: "ğŸ”­ å»£è§’/é­šçœ¼", desc: "è¦–é‡æ¥µå¯¬ï¼Œç•«é¢é‚Šç·£å¯èƒ½è®Šå½¢ï¼Œèƒ½å®¹ç´å£¯é—Šçš„å¤§æ™¯ã€‚" },
                    { tag: "Macro photography", label: "ğŸ” å¾®è·ç‰¹å¯«", desc: "æ¥µè¿‘è·é›¢æ‹æ”ï¼Œèƒ½çœ‹æ¸…æ˜†èŸ²è¤‡çœ¼æˆ–æ°´æ»´ç´°ç¯€ï¼ŒèƒŒæ™¯é€šå¸¸æ¨¡ç³Šã€‚" },
                    { tag: "Bokeh, depth of field", label: "ğŸŒ«ï¸ æ™¯æ·±æ¨¡ç³Š", desc: "ä¸»é«”æ¸…æ™°ï¼ŒèƒŒæ™¯è™›åŒ–æˆå…‰æ–‘ (Bokeh)ï¼Œç”¨ä¾†å‡¸é¡¯ä¸»è§’ã€‚" },
                    { tag: "Isometric view", label: "ğŸ“ ç­‰è·è¦–è§’", desc: "2.5D éŠæˆ²è¦–è§’ï¼Œç‰©é«”æ²’æœ‰è¿‘å¤§é å°çš„é€è¦–ï¼Œé©åˆå±•ç¤ºå»ºç¯‰æˆ–æˆ¿é–“çµæ§‹ã€‚" },
                    { tag: "Ground level shot, side view, focus on motion", label: "â¬‡ï¸ ä½è§’åº¦ (å´æ‹/åœ°é¢)", desc: "è²¼è¿‘åœ°é¢çš„è¦–è§’ï¼Œå¼·èª¿é‹å­æˆ–è»Šè¼ªçš„é€Ÿåº¦æ„Ÿï¼Œé¿å…ç”±ä¸‹å¾€ä¸Šçš„ä»°è§’ä»¥ç¬¦åˆå®‰å…¨è¦ç¯„ã€‚" },
                    { tag: "High-angle shot looking down", label: "ğŸ”­ é«˜è§’åº¦ä¿¯è¦–", desc: "ç”±ä¸Šå¾€ä¸‹çš„è¦–è§’ï¼Œå¼·èª¿åœ°é¢çš„ç´°ç¯€èˆ‡ä¸»é«”çš„ç›¸å°ä½ç½®ï¼ˆé¿å…ä¸»é«”æµ®ç©ºï¼‰ã€‚" },
                    { tag: "Low angle shot", label: "â¬‡ï¸ ä½è§’åº¦ä»°æ‹", desc: "ç›¸æ©Ÿä½ç½®æ¥µä½å‘ä¸Šæ‹æ”ï¼Œè®“ä¸»é«”çœ‹èµ·ä¾†å·¨å¤§ã€å¨åš´æˆ–å…·å£“è¿«æ„Ÿã€‚" }
                ]
            }
        };

        const state = {
            apiKey: '', refImageBase64: null, refImageMimeType: null, history: [],
            currentTab: 'phase1', selectedTags: {}, lastToastData: null, toastTimer: null,
            abortController: null
        };

        const els = {
            apiKeyInput: document.getElementById('apiKeyInput'),
            promptInput: document.getElementById('promptInput'),
            builderPrompt: document.getElementById('builderPrompt'),
            imageInput: document.getElementById('imageInput'),
            refImagePreview: document.getElementById('refImagePreview'),
            uploadPlaceholder: document.getElementById('uploadPlaceholder'),
            clearRefBtn: document.getElementById('clearRefBtn'),
            generateBtn: document.getElementById('generateBtn'),
            welcomeState: document.getElementById('welcomeState'),
            loadingState: document.getElementById('loadingState'),
            resultContainer: document.getElementById('resultContainer'),
            generatedImage: document.getElementById('generatedImage'),
            loadingTime: document.getElementById('loadingTime'),
            gallery: document.getElementById('gallery'),
            aspectRatio: document.getElementById('aspectRatio'),
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toastMsg'),
            toastTitle: document.getElementById('toastTitle'),
            toastIcon: document.getElementById('toastIcon'),
            tab1: document.getElementById('tab-phase1'),
            tab2: document.getElementById('tab-phase2'),
            selectedTagsPreview: document.getElementById('selectedTagsPreview'),
            tagCountBadge: document.getElementById('tagCountBadge'),
            taxonomyContainer: document.getElementById('taxonomyContainer'),
            styleTooltip: document.getElementById('styleTooltip'),
            tooltipTitle: document.getElementById('tooltipTitle'),
            tooltipDesc: document.getElementById('tooltipDesc'),
            lightbox: document.getElementById('lightbox'),
            lightboxImage: document.getElementById('lightboxImage'),
            anatomyFixCheck: document.getElementById('anatomyFixCheck')
        };

        document.addEventListener('DOMContentLoaded', () => {
            renderTaxonomy();
            lucide.createIcons();
            loadApiKey();
            setupDragAndDrop();
            switchTab('phase1');
            setupTooltip();
        });

        function openLightbox() {
            if (!els.generatedImage.src) return;
            els.lightboxImage.src = els.generatedImage.src;
            els.lightbox.classList.remove('hidden');
            setTimeout(() => { els.lightboxImage.classList.remove('scale-95', 'opacity-0'); }, 10);
        }

        function closeLightbox() {
            els.lightboxImage.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { els.lightbox.classList.add('hidden'); els.lightboxImage.src = ''; }, 300);
        }

        function renderTaxonomy() {
            els.taxonomyContainer.innerHTML = '';
            Object.entries(taxonomyData).forEach(([catName, catData]) => {
                const section = document.createElement('div');
                section.innerHTML = `
                    <h3 class="text-green-800 text-lg font-bold mb-4 flex items-center gap-2 border-b-2 border-green-100 pb-2 sticky top-0 bg-white z-10 py-2">
                        <span class="bg-${catData.color}-100 p-1.5 rounded-lg"><i data-lucide="${catData.icon}" class="w-5 h-5 text-${catData.color}-600"></i></span>
                        ${catName}
                    </h3>
                    <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 mb-10">
                    </div>
                `;
                const grid = section.querySelector('.grid');
                catData.items.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'tag-btn p-3 rounded-xl text-left text-sm relative group/btn';
                    btn.textContent = item.label;
                    btn.setAttribute('data-category', catName);
                    btn.setAttribute('data-title', item.label);
                    btn.setAttribute('data-desc', item.desc);
                    btn.onclick = () => toggleTag(btn, catName, item.tag);
                    grid.appendChild(btn);
                });
                els.taxonomyContainer.appendChild(section);
            });
        }

        function setupTooltip() {
            els.taxonomyContainer.addEventListener('mouseover', (e) => {
                const btn = e.target.closest('.tag-btn');
                if (btn) {
                    const title = btn.getAttribute('data-title');
                    const desc = btn.getAttribute('data-desc');
                    els.tooltipTitle.textContent = title.split(' ')[1] || title;
                    els.tooltipDesc.textContent = desc;
                    els.styleTooltip.classList.remove('hidden');
                    updateTooltipPos(e);
                }
            });
            els.taxonomyContainer.addEventListener('mousemove', (e) => { updateTooltipPos(e); });
            els.taxonomyContainer.addEventListener('mouseout', (e) => { if (e.target.closest('.tag-btn')) els.styleTooltip.classList.add('hidden'); });
        }

        function updateTooltipPos(e) {
            const x = e.clientX + 20;
            const y = e.clientY + 20;
            els.styleTooltip.style.top = `${y}px`;
            els.styleTooltip.style.left = `${x}px`;
        }

        function switchTab(tabId) {
            state.currentTab = tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabId}`).classList.add('active');

            if (tabId === 'phase1') {
                els.tab1.className = 'px-4 md:px-6 py-1.5 rounded-full text-sm font-bold transition-all duration-300 flex items-center gap-2 bg-yellow-400 text-green-900 shadow-lg';
                els.tab2.className = 'px-4 md:px-6 py-1.5 rounded-full text-sm font-bold transition-all duration-300 flex items-center gap-2 text-green-100 hover:text-white hover:bg-green-800';
            } else {
                els.tab2.className = 'px-4 md:px-6 py-1.5 rounded-full text-sm font-bold transition-all duration-300 flex items-center gap-2 bg-yellow-400 text-green-900 shadow-lg';
                els.tab1.className = 'px-4 md:px-6 py-1.5 rounded-full text-sm font-bold transition-all duration-300 flex items-center gap-2 text-green-100 hover:text-white hover:bg-green-800';
            }
        }

        function toggleTag(btn, category, tag) {
            if (state.selectedTags[category] === tag) {
                delete state.selectedTags[category];
                btn.classList.remove('active');
            } else {
                state.selectedTags[category] = tag;
                const buttons = document.querySelectorAll(`button[data-category="${category}"]`);
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateTagPreview();
        }

        function updateTagPreview() {
            const tags = Object.values(state.selectedTags).filter(Boolean);
            els.tagCountBadge.textContent = tags.length;
            if (tags.length === 0) {
                els.selectedTagsPreview.textContent = '(å°šæœªé¸æ“‡ä»»ä½•é¢¨æ ¼)';
                els.selectedTagsPreview.className = 'text-xs text-slate-500 italic h-8 overflow-y-auto leading-relaxed';
            } else {
                els.selectedTagsPreview.textContent = tags.join(', ');
                els.selectedTagsPreview.className = 'text-xs text-green-700 font-medium h-8 overflow-y-auto leading-relaxed';
            }
        }

        function transferToPhase2() {
            const basePrompt = els.builderPrompt.value.trim();
            const tags = Object.values(state.selectedTags).filter(Boolean).join(', ');
            let finalPrompt = basePrompt;
            if (basePrompt && tags) finalPrompt = `${basePrompt}, ${tags}`;
            else if (tags) finalPrompt = tags;
            els.promptInput.value = finalPrompt;
            switchTab('phase2');
        }

        async function generateImage() {
            if (!state.apiKey) { showToast('è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ API Key', 'error'); return; }
            if (!els.promptInput.value.trim()) { showToast('è«‹è¼¸å…¥æç¤ºè©', 'warning'); return; }

            if (state.abortController) state.abortController.abort();
            state.abortController = new AbortController();
            const signal = state.abortController.signal;
            const timeoutId = setTimeout(() => state.abortController.abort(), 60000);

            setLoading(true);
            const startTime = Date.now();
            const timer = setInterval(() => { els.loadingTime.textContent = ((Date.now() - startTime) / 1000).toFixed(1) + 's'; }, 100);

            try {
                const model = 'gemini-3-pro-image-preview';
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${state.apiKey}`;

                let anatomyFix = "";
                if (els.anatomyFixCheck && els.anatomyFixCheck.checked) {
                    anatomyFix = ", perfect anatomy, realistic proportions, symmetrical face, correct hands, high quality, 8k, detailed texture";
                }

                const safePrompt = els.promptInput.value + anatomyFix + ` (Aspect Ratio: ${els.aspectRatio.value})`;
                const parts = [{ text: safePrompt }];
                if (state.refImageBase64) {
                    const base64Data = state.refImageBase64.split(',')[1];
                    const mimeType = state.refImageMimeType || 'image/png';
                    parts.push({ inline_data: { mime_type: mimeType, data: base64Data } });
                }

                const safetySettings = [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
                ];

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: parts }],
                        safetySettings: safetySettings
                    }),
                    signal: signal
                });

                const data = await response.json();

                if (!response.ok) throw new Error(data.error?.message || 'API Error');

                if (data.candidates && data.candidates.length > 0) {
                    const candidate = data.candidates[0];
                    if (candidate.finishReason && candidate.finishReason !== 'STOP') {
                        throw new Error(`ç”Ÿæˆçµ‚æ­¢ (åŸå› : ${candidate.finishReason})ã€‚å¯èƒ½è§¸ç™¼å®‰å…¨éæ¿¾ï¼Œè«‹ä¿®æ”¹æç¤ºè©ã€‚`);
                    }
                }

                let imageBase64 = null;
                if (data.candidates?.[0]?.content?.parts) {
                    const part = data.candidates[0].content.parts.find(p => p.inline_data || (p.inlineData));
                    if (part) {
                        const inline = part.inline_data || part.inlineData;
                        imageBase64 = `data:${inline.mime_type};base64,${inline.data}`;
                    }
                }
                if (!imageBase64 && data.predictions?.[0]?.bytesBase64Encoded) {
                    imageBase64 = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                }

                if (imageBase64) {
                    displayResult(imageBase64);
                    addToHistory(imageBase64, els.promptInput.value);
                    showToast('ç”ŸæˆæˆåŠŸï¼', 'success');
                } else {
                    console.error('API Response Dump:', data);
                    throw new Error('å›æ‡‰ä¸­æœªæ‰¾åˆ°åœ–ç‰‡æ•¸æ“š (è«‹æª¢æŸ¥ Console æŸ¥çœ‹å®Œæ•´å›æ‡‰)');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showToast('è«‹æ±‚é€¾æ™‚ (60s)ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦', 'error');
                } else {
                    console.error(error);
                    showToast(`éŒ¯èª¤: ${error.message}`, 'error');
                }
            } finally {
                clearTimeout(timeoutId);
                clearInterval(timer);
                setLoading(false);
            }
        }

        function displayResult(src) {
            els.generatedImage.src = src;
            els.welcomeState.classList.add('hidden');
            els.resultContainer.classList.remove('hidden');
        }

        function setLoading(isLoading) {
            els.generateBtn.disabled = isLoading;
            els.generateBtn.innerHTML = isLoading ? '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> ç”Ÿæˆä¸­...' : '<i data-lucide="zap" class="w-5 h-5"></i> é–‹å§‹ç”Ÿæˆ';
            lucide.createIcons();
            els.loadingState.classList.toggle('hidden', !isLoading);
        }

        function setupDragAndDrop() {
            const dz = document.getElementById('dropZone');
            dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('border-yellow-400', 'bg-yellow-50'); });
            dz.addEventListener('dragleave', (e) => { e.preventDefault(); dz.classList.remove('border-yellow-400', 'bg-yellow-50'); });
            dz.addEventListener('drop', (e) => {
                e.preventDefault(); dz.classList.remove('border-yellow-400', 'bg-yellow-50');
                if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
            });
            els.imageInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) { showToast('è«‹ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ', 'error'); return; }

            if (file.size > 5 * 1024 * 1024) {
                showToast('åœ–ç‰‡éå¤§ (è¶…é 5MB)ï¼Œè«‹å£“ç¸®å¾Œå†ä¸Šå‚³', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                state.refImageBase64 = e.target.result;
                state.refImageMimeType = file.type;
                els.refImagePreview.src = state.refImageBase64;
                els.refImagePreview.classList.remove('hidden');
                els.uploadPlaceholder.classList.add('hidden');
                els.clearRefBtn.classList.remove('hidden');
                showToast('åƒè€ƒåœ–å·²è¼‰å…¥', 'success');
            };
            reader.readAsDataURL(file);
        }

        function clearRefImage() {
            state.refImageBase64 = null;
            els.imageInput.value = '';
            els.refImagePreview.classList.add('hidden');
            els.uploadPlaceholder.classList.remove('hidden');
            els.clearRefBtn.classList.add('hidden');
        }

        function addToHistory(url, prompt) {
            const item = { url, prompt, id: Date.now() };
            state.history.unshift(item);
            if (state.history.length > 10) state.history.pop();
            renderGallery();
        }

        function renderGallery() {
            els.gallery.innerHTML = '';
            const header = document.createElement('div');
            header.className = 'text-sm text-slate-400 font-medium italic px-6 flex items-center gap-2 shrink-0';
            header.innerHTML = '<i data-lucide="history" class="w-4 h-4"></i> æ­·å²è¨˜éŒ„ <span class="text-xs text-slate-300 ml-1">(é‡æ–°æ•´ç†å¾Œæ¸…ç©º)</span>';
            els.gallery.appendChild(header);

            state.history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'w-24 h-24 shrink-0 rounded-xl overflow-hidden border-2 border-slate-200 cursor-pointer hover:border-yellow-400 transition relative group shadow-sm';

                const img = document.createElement('img');
                img.src = item.url;
                img.className = 'w-full h-full object-cover';

                const overlay = document.createElement('div');
                overlay.className = 'absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity';

                const span = document.createElement('span');
                span.className = 'text-[10px] text-white font-bold p-1 text-center bg-black/50 rounded backdrop-blur-sm mx-1 line-clamp-2';
                span.textContent = item.prompt;

                overlay.appendChild(span);
                div.appendChild(img);
                div.appendChild(overlay);

                div.onclick = () => { displayResult(item.url); els.promptInput.value = item.prompt; };
                els.gallery.appendChild(div);
            });
            lucide.createIcons();
        }

        function useAsReference() {
            if (!els.generatedImage.src) return;
            const src = els.generatedImage.src;
            state.refImageBase64 = src;
            const match = src.match(/^data:(image\/[a-zA-Z+]+);base64,/);
            state.refImageMimeType = match ? match[1] : 'image/png';
            els.refImagePreview.src = state.refImageBase64;
            els.refImagePreview.classList.remove('hidden');
            els.uploadPlaceholder.classList.add('hidden');
            els.clearRefBtn.classList.remove('hidden');
            showToast('å·²å°‡çµæœè¨­ç‚ºåƒè€ƒåœ–', 'success');
        }

        function downloadImage() {
            if (!els.generatedImage.src) return;
            const a = document.createElement('a');
            a.href = els.generatedImage.src;
            a.download = `nano-banana-${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function copyToClipboard() {
            if (!els.generatedImage.src) return;
            try {
                const response = await fetch(els.generatedImage.src);
                const blob = await response.blob();
                await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
                showToast('åœ–ç‰‡å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            } catch (err) { console.error(err); showToast('è¤‡è£½å¤±æ•—', 'error'); }
        }

        function saveApiKey() {
            const key = els.apiKeyInput.value.trim();
            if (key) { localStorage.setItem('gemini_api_key', key); state.apiKey = key; showToast('API Key å·²å„²å­˜', 'success'); }
            else { localStorage.removeItem('gemini_api_key'); state.apiKey = ''; showToast('API Key å·²æ¸…é™¤', 'warning'); }
        }

        function clearAllData() {
            localStorage.removeItem('gemini_api_key');
            state.apiKey = '';
            els.apiKeyInput.value = '';
            state.history = [];
            state.refImageBase64 = null;
            renderGallery();
            clearRefImage();
            showToast('å·²ç™»å‡ºä¸¦æ¸…é™¤æ‰€æœ‰æš«å­˜è³‡æ–™', 'success');
        }

        function loadApiKey() {
            const key = localStorage.getItem('gemini_api_key');
            if (key) { els.apiKeyInput.value = key; state.apiKey = key; }
        }

        function toggleApiKeyVisibility() { els.apiKeyInput.type = els.apiKeyInput.type === 'password' ? 'text' : 'password'; }

        function showToast(msg, type = 'info') {
            state.lastToastData = { msg, type };

            els.toastMsg.textContent = msg;
            els.toast.classList.remove('translate-x-full');

            els.toast.className = 'fixed top-6 right-6 bg-white border-l-4 text-slate-800 px-6 py-4 rounded-r-lg shadow-2xl transform transition-transform duration-300 z-[100] flex items-center gap-4 min-w-[300px] cursor-pointer';
            const iconContainer = document.getElementById('toastIconContainer');

            if (type === 'success') {
                els.toast.classList.add('border-green-500');
                els.toastTitle.textContent = 'æˆåŠŸ';
                els.toastIcon.setAttribute('data-lucide', 'check');
                els.toastIcon.classList.add('text-green-600');
                iconContainer.className = 'p-2 bg-green-50 rounded-full';
            } else if (type === 'error') {
                els.toast.classList.add('border-red-500');
                els.toastTitle.textContent = 'éŒ¯èª¤ (é»æ“Šé—œé–‰)';
                els.toastIcon.setAttribute('data-lucide', 'alert-triangle');
                els.toastIcon.classList.add('text-red-600');
                iconContainer.className = 'p-2 bg-red-50 rounded-full';
            } else {
                els.toast.classList.add('border-yellow-400');
                els.toastTitle.textContent = 'é€šçŸ¥';
                els.toastIcon.setAttribute('data-lucide', 'info');
                els.toastIcon.classList.add('text-yellow-600');
                iconContainer.className = 'p-2 bg-yellow-50 rounded-full';
            }
            lucide.createIcons();

            if (state.toastTimer) clearTimeout(state.toastTimer);

            if (type !== 'error') {
                state.toastTimer = setTimeout(() => {
                    els.toast.classList.add('translate-x-full');
                }, 4000);
            }
        }

        function dismissToast() {
            els.toast.classList.add('translate-x-full');
        }

        function showLastToast() {
            if (state.lastToastData) {
                showToast(state.lastToastData.msg, state.lastToastData.type);
            } else {
                showToast('ç›®å‰æ²’æœ‰æ­·å²é€šçŸ¥', 'info');
            }
        }
    </script>
</body>

</html>